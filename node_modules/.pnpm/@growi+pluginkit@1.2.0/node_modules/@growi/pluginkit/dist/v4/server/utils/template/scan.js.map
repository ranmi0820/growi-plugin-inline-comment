{"version":3,"file":"scan.js","sources":["../../../../../src/v4/server/utils/template/scan.ts"],"sourcesContent":["import fs from 'node:fs';\nimport path from 'node:path';\n\nimport type { GrowiTemplatePluginValidationData } from '../../../../model';\nimport {\n  isTemplateStatusValid,\n  type TemplateStatus,\n  type TemplateSummary,\n} from '../../../interfaces';\nimport { getStatus } from './get-status';\nimport { validateTemplatePluginGrowiDirective } from './validate-growi-plugin-directive';\n\nexport const scanTemplate = async (\n  projectDirRoot: string,\n  templateId: string,\n  data: GrowiTemplatePluginValidationData,\n  opts?: {\n    pluginId?: string;\n  },\n): Promise<TemplateStatus[]> => {\n  const status: TemplateStatus[] = [];\n\n  const tplRootDirPath = path.resolve(projectDirRoot, 'dist', templateId);\n\n  let isDefaultPushed = false;\n  for await (const locale of data.supportingLocales) {\n    const tplDir = path.resolve(tplRootDirPath, locale);\n\n    try {\n      const stats = await getStatus(tplDir);\n      const { isTemplateExists, meta } = stats;\n\n      if (!isTemplateExists) throw new Error(\"'template.md does not exist.\");\n      if (meta == null) throw new Error(\"'meta.md does not exist.\");\n      if (meta?.title == null)\n        throw new Error(\"'meta.md does not contain the title.\");\n\n      const isDefault = !isDefaultPushed;\n      status.push({\n        pluginId: opts?.pluginId,\n        id: templateId,\n        locale,\n        isValid: true,\n        isDefault,\n        title: meta.title,\n        desc: meta.desc,\n      });\n      isDefaultPushed = true;\n    } catch (err) {\n      status.push({\n        pluginId: opts?.pluginId,\n        id: templateId,\n        locale,\n        isValid: false,\n        invalidReason: (err as Error).message,\n      });\n    }\n  }\n\n  // eslint-disable-next-line no-console\n  console.debug(`Template directory (${projectDirRoot}) has scanned`, {\n    status,\n  });\n\n  return status;\n};\n\nexport const scanAllTemplates = async (\n  projectDirRoot: string,\n  opts?: {\n    data?: GrowiTemplatePluginValidationData;\n    pluginId?: string;\n    returnsInvalidTemplates?: boolean;\n  },\n): Promise<TemplateSummary[]> => {\n  const data =\n    opts?.data ?? validateTemplatePluginGrowiDirective(projectDirRoot);\n\n  const summaries: TemplateSummary[] = [];\n\n  const distDirPath = path.resolve(projectDirRoot, 'dist');\n  const distDirFiles = fs.readdirSync(distDirPath);\n\n  for await (const templateId of distDirFiles) {\n    const status = (\n      await scanTemplate(projectDirRoot, templateId, data, {\n        pluginId: opts?.pluginId,\n      })\n    )\n      // omit invalid templates if `returnsInvalidTemplates` is true\n      .filter((s) => (opts?.returnsInvalidTemplates ? true : s.isValid));\n\n    // determine default locale\n    const defaultTemplateStatus = status.find(\n      (s) => 'isDefault' in s && s.isDefault,\n    );\n\n    if (\n      defaultTemplateStatus == null ||\n      !isTemplateStatusValid(defaultTemplateStatus)\n    ) {\n      continue;\n    }\n\n    summaries.push({\n      // for the 'default' key\n      default: defaultTemplateStatus,\n      // for each locale keys\n      ...Object.fromEntries(\n        status.map((templateStatus) => [templateStatus.locale, templateStatus]),\n      ),\n    });\n  }\n\n  return summaries;\n};\n"],"names":["scanTemplate","projectDirRoot","templateId","data","opts","status","tplRootDirPath","path","isDefaultPushed","locale","tplDir","stats","getStatus","isTemplateExists","meta","isDefault","err","scanAllTemplates","validateTemplatePluginGrowiDirective","summaries","distDirPath","distDirFiles","fs","s","defaultTemplateStatus","isTemplateStatusValid","templateStatus"],"mappings":";;;;;AAYO,MAAMA,IAAe,OAC1BC,GACAC,GACAC,GACAC,MAG8B;AAC9B,QAAMC,IAA2B,CAAC,GAE5BC,IAAiBC,EAAK,QAAQN,GAAgB,QAAQC,CAAU;AAEtE,MAAIM,IAAkB;AACL,mBAAAC,KAAUN,EAAK,mBAAmB;AACjD,UAAMO,IAASH,EAAK,QAAQD,GAAgBG,CAAM;AAE9C,QAAA;AACI,YAAAE,IAAQ,MAAMC,EAAUF,CAAM,GAC9B,EAAE,kBAAAG,GAAkB,MAAAC,EAAA,IAASH;AAEnC,UAAI,CAACE,EAAwB,OAAA,IAAI,MAAM,8BAA8B;AACrE,UAAIC,KAAQ,KAAY,OAAA,IAAI,MAAM,0BAA0B;AAC5D,WAAIA,KAAA,gBAAAA,EAAM,UAAS;AACX,cAAA,IAAI,MAAM,sCAAsC;AAExD,YAAMC,IAAY,CAACP;AACnB,MAAAH,EAAO,KAAK;AAAA,QACV,UAAUD,KAAA,gBAAAA,EAAM;AAAA,QAChB,IAAIF;AAAA,QACJ,QAAAO;AAAA,QACA,SAAS;AAAA,QACT,WAAAM;AAAA,QACA,OAAOD,EAAK;AAAA,QACZ,MAAMA,EAAK;AAAA,MAAA,CACZ,GACiBN,IAAA;AAAA,aACXQ,GAAK;AACZ,MAAAX,EAAO,KAAK;AAAA,QACV,UAAUD,KAAA,gBAAAA,EAAM;AAAA,QAChB,IAAIF;AAAA,QACJ,QAAAO;AAAA,QACA,SAAS;AAAA,QACT,eAAgBO,EAAc;AAAA,MAAA,CAC/B;AAAA,IAAA;AAAA,EACH;AAIM,iBAAA,MAAM,uBAAuBf,CAAc,iBAAiB;AAAA,IAClE,QAAAI;AAAA,EAAA,CACD,GAEMA;AACT,GAEaY,IAAmB,OAC9BhB,GACAG,MAK+B;AAC/B,QAAMD,KACJC,KAAA,gBAAAA,EAAM,SAAQc,EAAqCjB,CAAc,GAE7DkB,IAA+B,CAAC,GAEhCC,IAAcb,EAAK,QAAQN,GAAgB,MAAM,GACjDoB,IAAeC,EAAG,YAAYF,CAAW;AAE/C,mBAAiBlB,KAAcmB,GAAc;AAC3C,UAAMhB,KACJ,MAAML,EAAaC,GAAgBC,GAAYC,GAAM;AAAA,MACnD,UAAUC,KAAA,gBAAAA,EAAM;AAAA,IAAA,CACjB,GAGA,OAAO,CAACmB,MAAOnB,KAAA,QAAAA,EAAM,0BAA0B,KAAOmB,EAAE,OAAQ,GAG7DC,IAAwBnB,EAAO;AAAA,MACnC,CAACkB,MAAM,eAAeA,KAAKA,EAAE;AAAA,IAC/B;AAEA,IACEC,KAAyB,QACzB,CAACC,EAAsBD,CAAqB,KAK9CL,EAAU,KAAK;AAAA;AAAA,MAEb,SAASK;AAAA;AAAA,MAET,GAAG,OAAO;AAAA,QACRnB,EAAO,IAAI,CAACqB,MAAmB,CAACA,EAAe,QAAQA,CAAc,CAAC;AAAA,MAAA;AAAA,IACxE,CACD;AAAA,EAAA;AAGI,SAAAP;AACT;"}